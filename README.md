# @deno/bump-workspaces

> A tool for upgrading Deno workspace packages using conventional commits

[![ci](https://github.com/denoland/bump-workspaces/actions/workflows/ci.yml/badge.svg)](https://github.com/denoland/bump-workspaces/actions/workflows/ci.yml)
[![codecov](https://codecov.io/gh/denoland/bump-workspaces/graph/badge.svg?token=KUT5Q1PJE6)](https://codecov.io/gh/denoland/bump-workspaces)

This tool detects necessary version upgrades for workspaces packages using
[Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) and
creates a PR.

# Try it

Run this command with `--dry-run` flag in your Deno workspace-enabled project
and see what this command does:

```sh
deno run -A jsr:@deno/bump-workspaces@0.1.22/cli --dry-run
```

# How it works

The below steps describe what this command does:

- Read `deno.json` at the current directory. Read "workspaces". Read `deno.json`
  of each workspace package.
- Collect the git commit messages between the latest tag and the current branch.
- Calculate the necessary updates for each package. (See the below table for
  what version upgrades are performed for each conventional commit tag.)
- Create and print the release note.
- Stop here if `--dry-run` specified, and continue if not.
- Save necessary updates to each `deno.json`.
- Create a new branch `release-YYYY-MM-DD`
- Make git commit the version changes using `GIT_USER_NAME` and `GIT_USER_EMAIL`
  env vars.
- Create a github pull request using `GITHUB_TOKEN` and `GITHUB_REPOSITORY` env
  vars.
- That's all.

Note: Don't worry if your commits don't completely follow conventional commits.
You can still manually update the PR generated by this tool. The PR body
includes the information about which commits are handled by this tool and which
are not.

# CI set up

Set up the GitHub Actions yaml like the below, and trigger the workflow
manually:

```yaml
name: version_bump

on: workflow_dispatch

jobs:
  build:
    name: version bump
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v1

      - name: Run workspaces version bump
        run: |
          git fetch --unshallow origin
          deno run -A jsr:@deno/bump-workspaces@0.1.22/cli
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
```

Example pull request: https://github.com/kt3k/deno_std/pull/34

## Commit titles

This tool uses the commit titles as the input for detecting which modules and
versions to update. The commit titles need to follow the following format:

```
<tag>(<scopes,...>): <commit message>
```

Some examples are:

```
fix(foo): fix a bug
fix(baz,qux): fix a bug
feat(bar): add a new feature
chore(foo): clean up
chore(bar): clean up
BREAKING(quux): some breaking change
```

This example results in the following version updates:

| module | version |
| ------ | ------- |
| foo    | patch   |
| bar    | minor   |
| baz    | patch   |
| qux    | patch   |
| quux   | major   |

The tool automatically detects following commit tags:

- BREAKING
- feat
- fix
- perf
- docs
- deprecation
- refactor
- test
- style
- chore

If a module has `BREAKING` commits, then `major` version will be updated. If a
module has `feat` commits, `minor` version will be updated. Otherwise `patch`
version will be updated.

| tag         | version |
| ----------- | ------- |
| BREAKING    | major   |
| feat        | minor   |
| fix         | patch   |
| perf        | patch   |
| docs        | patch   |
| deprecation | patch   |
| refactor    | patch   |
| test        | patch   |
| style       | patch   |
| chore       | patch   |

## Scope required tags

The following tags require scope specified because they don't make sense without
scopes. If these tags specified without scopes, they are raised as diagnostics
in README.

- BREAKING
- feat
- fix
- perf
- deprecation

## Wildcard scope

You can use `*` for the scope. That commit affects all the packages in the
workspace. For example:

```
refactor(*): clean up
```

The above commit causes `patch` upgrade to the all packages.

## Unstable updates

You can mark the change only affects the unstable part of the package by using
`scope/unstable` or `unstable/scope`.

```
feat(crypto/unstable): a new unstable feature
BREAKING(crypto/unstable): breaking change to unstable feature
```

If this notation is used, the effect of the commit becomes `patch` no matter
what commit type is used.

# Per-Package Publishing

The bump-workspaces library supports per-package publishing mode, which allows you to create individual releases, tags, and PRs for each package in your workspace instead of a single monolithic release.

## Usage

### Basic Per-Package Mode

```sh
deno run -A jsr:@deno/bump-workspaces/cli --publish-mode per-package
```

### With Individual Options

```sh
# Create individual PRs for each package
deno run -A jsr:@deno/bump-workspaces/cli --publish-mode per-package --individual-prs

# Create individual git tags for each package
deno run -A jsr:@deno/bump-workspaces/cli --publish-mode per-package --individual-tags

# Create individual release notes for each package
deno run -A jsr:@deno/bump-workspaces/cli --publish-mode per-package --individual-release-notes

# All individual options combined
deno run -A jsr:@deno/bump-workspaces/cli \
  --publish-mode per-package \
  --individual-prs \
  --individual-tags \
  --individual-release-notes
```

### Programmatic Usage

```typescript
import { bumpWorkspaces } from "jsr:@deno/bump-workspaces";

await bumpWorkspaces({
  publishMode: "per-package",
  individualPRs: true,
  individualTags: true,
  individualReleaseNotes: true,
  // ... other options
});
```

## Options

### `publishMode`
- **Type**: `"workspace" | "per-package"`
- **Default**: `"workspace"`
- **Description**: Determines the publishing strategy.
  - `"workspace"`: Creates a single release with all package updates (default behavior)
  - `"per-package"`: Creates individual releases for each package

### `releaseNotePath`
- **Type**: `string`
- **Default**: `"Releases.md"` (workspace mode) or `"CHANGELOG.md"` (per-package mode)
- **Description**: The filename for release notes. In per-package mode, this file is created in each package directory.

### `individualPRs`
- **Type**: `boolean`
- **Default**: `false`
- **Description**: When using per-package mode, creates individual pull requests for each package instead of a single PR containing all updates.

### `individualTags`
- **Type**: `boolean`
- **Default**: `true`
- **Description**: When using per-package mode, creates individual git tags for each package in the format `package-name@version`.

### `individualReleaseNotes`
- **Type**: `boolean`
- **Default**: `false`
- **Description**: When using per-package mode, creates release note files in each package directory. When `false`, only a workspace-level release note is created.

## Behavior Comparison

### Workspace Mode (Default)
- ‚úÖ Single release note file (`Releases.md`) in workspace root
- ‚úÖ Single git commit with all changes
- ‚úÖ Single pull request
- ‚úÖ Single git tag (optional)
- üìÅ Consolidated view of all changes

### Per-Package Mode
- ‚úÖ Release notes in individual package directories (`CHANGELOG.md` by default)
- ‚úÖ Individual git tags per package (`@scope/package@1.2.3`)
- ‚úÖ Individual or single PR (configurable)
- ‚úÖ Granular control over package releases
- üì¶ Package-focused release process

## Examples

### Scenario 1: Individual PRs with Tags

Perfect for teams that want to review each package separately:

```sh
deno run -A jsr:@deno/bump-workspaces/cli \
  --publish-mode per-package \
  --individual-prs \
  --individual-tags
```

**Result:**
- Separate PR for each updated package
- Individual git tags like `@myorg/utils@1.2.0`, `@myorg/core@2.1.0`
- `CHANGELOG.md` files in each package directory
- Single workspace-level `CHANGELOG.md` file

### Scenario 2: Single PR with Package Breakdown

Good for maintaining a single review process while organizing by package:

```sh
deno run -A jsr:@deno/bump-workspaces/cli \
  --publish-mode per-package \
  --individual-tags \
  --individual-release-notes
```

**Result:**
- Single PR with per-package sections
- Individual git tags for each package
- `CHANGELOG.md` files in each package directory (if `--individual-release-notes`)
- Single workspace-level `CHANGELOG.md` file

### Scenario 3: Full Individual Publishing

Maximum granularity for independent package lifecycles:

```sh
deno run -A jsr:@deno/bump-workspaces/cli \
  --publish-mode per-package \
  --individual-prs \
  --individual-tags \
  --individual-release-notes
```

**Result:**
- Separate PR for each package
- Individual git tags for each package
- `CHANGELOG.md` files in each package directory
- Workspace-level `CHANGELOG.md` file

## Git Tag Format

In per-package mode with `individualTags: true`, git tags are created in the format:

```
package-name@version
```

Examples:
- `@myorg/utils@1.2.0`
- `@myorg/core@2.1.0`
- `simple-package@0.5.0`

## Release Note Files

### Workspace Mode
- **Main release notes**: `Releases.md` in workspace root

### Per-Package Mode
- **Workspace release notes**: `CHANGELOG.md` in workspace root (always created)
- **Package release notes**: `CHANGELOG.md` in each package directory (when `individualReleaseNotes: true`)

### File Structure Example
```
workspace/
‚îú‚îÄ‚îÄ CHANGELOG.md                    # Workspace-level (per-package mode)
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CHANGELOG.md           # Package-level (if individualReleaseNotes: true)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deno.json
‚îÇ   ‚îî‚îÄ‚îÄ core/
‚îÇ       ‚îú‚îÄ‚îÄ CHANGELOG.md           # Package-level (if individualReleaseNotes: true)
‚îÇ       ‚îî‚îÄ‚îÄ deno.json
‚îî‚îÄ‚îÄ deno.json
```

**Package directory detection**: Release notes are automatically placed in the correct package directory based on the package's `deno.json` location. For example:
- Package at `./packages/utils/deno.json` ‚Üí Release notes at `./packages/utils/CHANGELOG.md`
- Package at `./foo/deno.json` ‚Üí Release notes at `./foo/CHANGELOG.md`

# License

MIT
